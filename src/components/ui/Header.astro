---
import { Image } from "astro:assets";
import type {HeaderProps} from "../../lib/types";


const dataHeader: HeaderProps = [
    { id: 1, name: "Inicio", href: "/" },
    { id: 2, name: "Nosotros", href: "#nosotros" },
    { id: 3, name: "Servicios", href: "#servicios" },
    { id: 4, name: "Clientes", href: "#clientes" },
    { id: 5, name: "Contacto", href: "#contacto" },
];
---

<header
    class="fixed top-0 w-full z-50 transition-all duration-300 border-b border-transparent"
    id="headerItem"
>
    <div
        class="w-full max-w-7xl mx-auto px-6 py-4 grid items-center grid-cols-2 md:grid-cols-9 relative"
    >
        <div
            class="flex items-center justify-start relative z-50 md:col-span-2"
        >
            <a href="/" aria-label="Logo Vilchez Group">
                <Image
                    src="/images/logo.png"
                    alt="Logo"
                    width={1495}
                    height={355}
                    format="png"
                    quality="high"
                    loading="lazy"
                    class="h-10 w-auto object-contain"
                />
            </a>
        </div>

        <div
            id="menuDesktop"
            class="hidden md:flex items-center justify-center md:col-span-5"
        >
            <nav
                class="flex justify-center items-center gap-1 backdrop-blur-md rounded-full px-2 py-1 bg-white/5 border border-white/10 transition-all duration-300"
                id="navPill"
            >
                {
                    dataHeader.map((item) => (
                        <a
                            class="text-sm font-medium text-gray-200 hover:text-white hover:bg-white/10 px-4 py-1.5 rounded-full transition-all duration-300 uppercase tracking-wide"
                            href={item.href}
                        >
                            {item.name}
                        </a>
                    ))
                }
            </nav>
        </div>

        <div
            class="flex justify-end gap-3 relative z-50 items-center md:col-span-2"
        >
            <a
                href="https://wa.link/g67lxd"
                target="_blank"
                class="hidden md:flex flex-row items-center gap-2 px-5 py-2 rounded-full bg-[#0092b8] hover:bg-[#007a99] text-white font-semibold text-sm transition-all shadow-lg shadow-cyan-500/20 hover:scale-105"
            >
                Contactar
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="w-4 h-4"
                    ><path
                        d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                    ></path></svg
                >
            </a>

            <button
                id="buttonClose"
                class="relative flex flex-col justify-center items-center w-10 h-10 gap-1.5 md:hidden group focus:outline-none"
                aria-label="Menu"
            >
                <span
                    class="line h-0.5 w-6 bg-white rounded-full transition-all duration-300 origin-center"
                ></span>
                <span
                    class="line h-0.5 w-6 bg-white rounded-full transition-all duration-300 origin-center"
                ></span>
                <span
                    class="line h-0.5 w-6 bg-white rounded-full transition-all duration-300 origin-center"
                ></span>
            </button>
        </div>

        <div
            id="menuMobile"
            class="fixed inset-0 bg-[#09090b] flex flex-col justify-center items-center gap-8 text-white transition-all duration-300 translate-y-[-100%] z-40 md:hidden opacity-0 pointer-events-none"
        >
            <ul class="flex flex-col items-center gap-8 text-center">
                {
                    dataHeader.map((item) => (
                        <li>
                            <a
                                class="text-2xl font-bold hover:text-[#0092b8] transition-colors uppercase tracking-widest"
                                href={item.href}
                                onclick="closeMenu()"
                            >
                                {item.name}
                            </a>
                        </li>
                    ))
                }
            </ul>
            <a
                href="#contacto"
                onclick="closeMenu()"
                class="px-8 py-3 bg-[#0092b8] rounded-full font-bold text-white shadow-lg shadow-cyan-500/20"
            >
                Cotizar Ahora
            </a>
        </div>
    </div>
</header>

<script is:inline>
    const header = document.getElementById("headerItem");
    const navPill = document.getElementById("navPill");
    const btnClose = document.getElementById("buttonClose");
    const lines = btnClose.querySelectorAll(".line");
    const menuMobile = document.getElementById("menuMobile");

    let isMenuOpen = false;
    let ticking = false; // Variable para controlar el requestAnimationFrame

    // 1. Separamos la lógica visual en su propia función
    const updateHeader = () => {
        if (isMenuOpen) return;

        // Leemos la posición
        const scrollPos = window.scrollY;

        // Escribimos en el DOM (Solo cuando el navegador esté listo)
        if (scrollPos > 20) {
            header.classList.add(
                "bg-black",
                "shadow-xl",
                "border-[#0092b8]/50",
            );
            header.classList.remove(
                "border-transparent",
                "bg-transparent",
                "backdrop-blur-md",
            );

            if (navPill) {
                navPill.classList.replace("bg-white/5", "bg-transparent");
                navPill.classList.replace(
                    "border-white/10",
                    "border-transparent",
                );
            }
        } else {
            header.classList.remove(
                "bg-black",
                "shadow-xl",
                "border-[#0092b8]/50",
            );
            header.classList.add("border-transparent");
            if (navPill) {
                navPill.classList.replace("bg-transparent", "bg-white/5");
                navPill.classList.replace(
                    "border-transparent",
                    "border-white/10",
                );
            }
        }
        
        // Liberamos el candado para permitir la siguiente actualización
        ticking = false;
    };

    // 2. El evento de scroll solo "solicita" una actualización, no la ejecuta directamente
    const onScroll = () => {
        if (!ticking) {
            window.requestAnimationFrame(updateHeader);
            ticking = true;
        }
    };

    // Listener optimizado
    window.addEventListener("scroll", onScroll, { passive: true });
    
    // Ejecutar una vez al inicio para verificar posición
    updateHeader();

    // --- Lógica del Menú (Sin cambios mayores, solo integración) ---

    const toggleMenu = () => {
        isMenuOpen = !isMenuOpen;

        if (isMenuOpen) {
            menuMobile.classList.remove(
                "translate-y-[-100%]",
                "opacity-0",
                "pointer-events-none",
            );
            lines[0].classList.add("rotate-45", "translate-y-[8px]");
            lines[1].classList.add("opacity-0");
            lines[2].classList.add("-rotate-45", "-translate-y-[8px]");

            document.body.style.overflow = "hidden";

            // Forzar estado transparente al abrir menú
            header.classList.remove(
                "bg-black",
                "shadow-xl",
                "border-[#0092b8]/50",
            );
            header.classList.add("border-transparent", "bg-transparent");
        } else {
            menuMobile.classList.add(
                "translate-y-[-100%]",
                "opacity-0",
                "pointer-events-none",
            );

            lines[0].classList.remove("rotate-45", "translate-y-[8px]");
            lines[1].classList.remove("opacity-0");
            lines[2].classList.remove("-rotate-45", "-translate-y-[8px]");

            document.body.style.overflow = "auto";
            
            // Re-chequear el scroll al cerrar
            updateHeader();
        }
    };

    window.closeMenu = () => {
        if (isMenuOpen) toggleMenu();
    };

    btnClose.addEventListener("click", toggleMenu);
</script>
